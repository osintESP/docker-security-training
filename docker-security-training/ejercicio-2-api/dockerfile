# -------------------------------------------------------------------------
# ETAPA 1: DEPS INSTALLER (Instalar dependencias)
# Usaremos 'deps_installer' como alias para esta etapa
FROM python:3.11-slim@sha256:193fdd0bbcb3d2ae612bd6cc3548d2f7c78d65b549fcaa8af75624c47474444d AS deps_installer 

WORKDIR /tmp
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# -------------------------------------------------------------------------
# ETAPA 2: FINAL (Imagen mínima y segura para ejecución)
# NO le damos un alias, ya que es la etapa final.
FROM python:3.11-slim@sha256:193fdd0bbcb3d2ae612bd6cc3548d2f7c78d65b549fcaa8af75624c47474444d 

# ... (El resto de la configuración de seguridad y usuario)
# Crear y establecer el usuario no root
RUN groupadd -r appgroup && useradd -r -g appgroup -s /bin/false appuser

# Copiamos solo los artefactos necesarios
WORKDIR /app
# USAMOS EL ALIAS CORREGIDO: 'deps_installer'
COPY --from=deps_installer /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY api.py .

# Establecer el usuario no root para la ejecución
USER appuser

EXPOSE 5000

CMD ["python", "api.py"]