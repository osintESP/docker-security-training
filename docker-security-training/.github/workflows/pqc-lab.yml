name: PQC Lab CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Generate PQC Certificates
      working-directory: ./ejercicio-10
      run: |
        chmod +x generate_certs.sh
        ./generate_certs.sh

    - name: Build Docker Image
      working-directory: ./ejercicio-10
      run: |
        docker build -t pqc-lab:test .

    - name: Run PQC Server
      run: |
        docker run -d --name pqc-server -p 4433:4433 pqc-lab:test
        sleep 5 # Esperar a que inicie

    - name: Test PQC Connection (OQS Curl)
      run: |
        # Usamos la red del host para acceder al puerto expuesto
        docker run --network host --rm openquantumsafe/curl curl -k https://localhost:4433 -v
